==========================================
åœ°é›·ç¶“é©—ï¼šLM Studio + LangGraph Function Calling æ¨¡å‹é¸æ“‡
==========================================

æ—¥æœŸï¼š2025-11-23
å°ˆæ¡ˆï¼šlanggraph-local (LangGraph + MCP + LM Studio Agentic AI)

## å•é¡Œæè¿°

åœ¨ä½¿ç”¨ LangGraph + MCP + LM Studio å»ºç«‹ Agentic AI æ™‚ï¼Œé‡åˆ°å·¥å…·èª¿ç”¨ï¼ˆfunction callingï¼‰ç„¡æ³•æ­£å¸¸å·¥ä½œçš„å•é¡Œã€‚

## ç—‡ç‹€

1. **Gemma 3n æ¨¡å‹**ï¼š
   - Agent åªè¼¸å‡º JSON æ–‡å­—ï¼ˆå¦‚ `{"name": "list_directory", "arguments": {...}}`ï¼‰
   - ä¸æœƒè§¸ç™¼å¯¦éš›çš„å·¥å…·èª¿ç”¨
   - LangChain ç„¡æ³•è§£æç‚º `tool_calls`
   - ReAct å¾ªç’°ç„¡æ³•å®Œæˆ

2. **éŒ¯èª¤è¨Šæ¯**ï¼š
   ```
   StructuredTool does not support sync invocation.
   ```
   - é€™æ˜¯å› ç‚º MCP å·¥å…·æ˜¯ç•°æ­¥çš„ï¼Œä½†ä½¿ç”¨äº†åŒæ­¥èª¿ç”¨

## æ ¹æœ¬åŸå› 

### 1. Gemma 3/3n ä¸æ”¯æ´åŸç”Ÿ Function Calling

**é—œéµç™¼ç¾**ï¼š
- Gemma 3/3n **æ²’æœ‰å°ˆç”¨çš„ tool use token**
- åƒ…ä¾è³´ prompt engineering å’ŒæŒ‡ä»¤éµå¾ªèƒ½åŠ›
- æ¨¡å‹åªæœƒè¼¸å‡º JSON æ–‡å­—ï¼Œç„¡æ³•è§¸ç™¼ LangChain çš„ `tool_calls` æ©Ÿåˆ¶

**åƒè€ƒè³‡æ–™**ï¼š
- https://ai.google.dev/gemma/docs/capabilities/function-calling
- https://www.philschmid.de/gemma-function-calling
- https://github.com/ollama/ollama/issues/9680

### 2. MCP å·¥å…· Schema æ ¼å¼å•é¡Œ

**å•é¡Œ**ï¼š
- MCP filesystem server çš„ `inputSchema` åªæœ‰ `$schema`ï¼Œç¼ºå°‘ï¼š
  - `"type": "object"`
  - `"properties": {...}`
  - `"required": [...]`

**LM Studio è¦æ±‚**ï¼š
- å¿…é ˆç¬¦åˆ OpenAI function calling æ ¼å¼
- `parameters` å¿…é ˆåŒ…å«å®Œæ•´çš„ JSON Schema

**åƒè€ƒè³‡æ–™**ï¼š
- https://lmstudio.ai/docs/developer/openai-compat/tools
- https://github.com/openai/openai-agents-python/issues/449

### 3. ç•°æ­¥/åŒæ­¥èª¿ç”¨å•é¡Œ

**å•é¡Œ**ï¼š
- MCP å·¥å…·æ˜¯ç•°æ­¥çš„ï¼ˆasyncï¼‰
- ä½†åœ¨ FastAPI async endpoint ä¸­ä½¿ç”¨äº†åŒæ­¥çš„ `agent.chat()`
- å°è‡´ `StructuredTool does not support sync invocation` éŒ¯èª¤

## è§£æ±ºæ–¹æ¡ˆ

### âœ… æ–¹æ¡ˆ 1ï¼šä½¿ç”¨æ”¯æ´ Function Calling çš„æ¨¡å‹ï¼ˆæ¨è–¦ï¼‰

**æ”¯æ´ Function Calling çš„æ¨¡å‹**ï¼š
- âœ… **gpt-oss-20b** (OpenAI) - **æ¨è–¦ï¼åŸç”Ÿæ”¯æ´**
- âœ… **qwen2.5** (Alibaba) - æ”¯æ´ function calling
- âœ… **mistral** (Mistral AI) - æ”¯æ´ function calling
- âœ… **llama-3.1/3.2** (Meta) - æ”¯æ´ function calling

**ä¸æ”¯æ´çš„æ¨¡å‹**ï¼š
- âš ï¸ **gemma-3n** (Google) - ä¸æ”¯æ´åŸç”Ÿ function calling

**å¯¦ä½œ**ï¼š
```python
# agent.py
def __init__(self, base_url: str = "http://localhost:1234/v1",
             model: str = "gpt-oss-20b-mlx"):  # â† æ”¹ç”¨ gpt-oss-20b
```

**åƒè€ƒè³‡æ–™**ï¼š
- https://openai.com/index/introducing-gpt-oss/
- https://lmstudio.ai/models/openai/gpt-oss-20b

### âœ… æ–¹æ¡ˆ 2ï¼šä¿®æ­£ MCP å·¥å…· Schema

**å•é¡Œ**ï¼šMCP å·¥å…·ç¼ºå°‘å®Œæ•´çš„ schema å®šç¾©

**è§£æ±ºæ–¹å¼**ï¼šæ‰‹å‹•æ·»åŠ å®Œæ•´çš„ schema

```python
def _fix_tool_schemas(self, tools):
    """ä¿®æ­£ MCP å·¥å…· schema ä½¿å…¶ç¬¦åˆ OpenAI/LM Studio æ ¼å¼"""

    TOOL_SCHEMAS = {
        "list_directory": {
            "type": "object",  # â† å¿…é ˆæœ‰
            "properties": {    # â† å¿…é ˆæœ‰
                "path": {"type": "string", "description": "ç›®éŒ„è·¯å¾‘"}
            },
            "required": ["path"]  # â† å¿…é ˆæœ‰
        },
        # ... å…¶ä»–å·¥å…·
    }

    for tool in tools:
        if tool.name in TOOL_SCHEMAS:
            tool.args_schema = TOOL_SCHEMAS[tool.name]

    return tools
```

**ä½ç½®**ï¼š`agent.py` ç¬¬ 106-261 è¡Œ

### âœ… æ–¹æ¡ˆ 3ï¼šä¿®æ­£ç•°æ­¥èª¿ç”¨å•é¡Œ

**å•é¡Œ**ï¼šåœ¨ async endpoint ä¸­ä½¿ç”¨äº†åŒæ­¥çš„ `agent.chat()`

**è§£æ±ºæ–¹å¼**ï¼šå‰µå»ºç•°æ­¥ç‰ˆæœ¬çš„ chat æ–¹æ³•

```python
# agent.py
async def achat(self, user_message: str, thread_id: str = "default") -> str:
    """ç•°æ­¥ç‰ˆæœ¬çš„ chat æ–¹æ³•"""
    result = await self.agent.ainvoke(  # â† ä½¿ç”¨ ainvoke
        {"messages": [HumanMessage(content=user_message)]},
        config=config
    )
    return final_message

# server.py
@app.post("/chat")
async def chat(request: ChatRequest):
    response = await agent.achat(  # â† ä½¿ç”¨ await
        user_message=request.message,
        thread_id=request.thread_id
    )
```

**ä½ç½®**ï¼š
- `agent.py` ç¬¬ 263-328 è¡Œ
- `server.py` ç¬¬ 127 è¡Œ

## æ¸¬è©¦é©—è­‰

### âœ… æˆåŠŸçš„æ¸¬è©¦çµæœï¼ˆgpt-oss-20bï¼‰

```bash
curl -X POST http://localhost:8011/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "è«‹åˆ—å‡ºç•¶å‰ç›®éŒ„æœ‰å“ªäº› Python æª”æ¡ˆï¼Ÿ", "thread_id": "test"}'
```

**åŸ·è¡Œè»Œè·¡**ï¼š
```
--- Agent åŸ·è¡Œè»Œè·¡ ---
  [0] ğŸ‘¤ ä½¿ç”¨è€…: è«‹åˆ—å‡ºç•¶å‰ç›®éŒ„æœ‰å“ªäº› Python æª”æ¡ˆï¼Ÿ
  [1] ğŸ”§ Agent å‘¼å«å·¥å…·: ['list_directory']  â† âœ… æˆåŠŸèª¿ç”¨ï¼
  [2] ğŸ“Š å·¥å…·çµæœ: [DIR] .git, [FILE] agent.py...  â† âœ… è¿”å›çµæœï¼
  [3] ğŸ¤– Agent å›æ‡‰: Here are all the Python files...  â† âœ… æ•´åˆå›ç­”ï¼
--- åŸ·è¡Œå®Œæˆ ---
```

**å›æ‡‰**ï¼šæˆåŠŸåˆ—å‡ºæ‰€æœ‰ Python æª”æ¡ˆï¼ˆagent.py, server.py ç­‰ï¼‰

### âŒ å¤±æ•—çš„æ¸¬è©¦çµæœï¼ˆgemma-3nï¼‰

**åŸ·è¡Œè»Œè·¡**ï¼š
```
--- Agent åŸ·è¡Œè»Œè·¡ ---
  [0] ğŸ‘¤ ä½¿ç”¨è€…: hello
  [1] ğŸ¤– Agent å›æ‡‰: ```tool_request
{
  "name": "list_directory",
  "arguments": {"path": "/"}
}
```  â† âŒ åªè¼¸å‡º JSON æ–‡å­—ï¼Œæ²’æœ‰å¯¦éš›èª¿ç”¨å·¥å…·
--- åŸ·è¡Œå®Œæˆ ---
```

## é—œéµå­¸ç¿’

### 1. æ¨¡å‹é¸æ“‡è‡³é—œé‡è¦

**ä¸æ˜¯æ‰€æœ‰æ¨¡å‹éƒ½æ”¯æ´ function callingï¼**

åœ¨ä½¿ç”¨ LangChain/LangGraph çš„å·¥å…·èª¿ç”¨åŠŸèƒ½æ™‚ï¼Œå¿…é ˆï¼š
1. ç¢ºèªæ¨¡å‹æ˜¯å¦æœ‰åŸç”Ÿ function calling æ”¯æ´
2. æª¢æŸ¥æ¨¡å‹æ–‡æª”ä¸­çš„ "tool use" æˆ– "function calling" èƒ½åŠ›
3. å„ªå…ˆé¸æ“‡æ˜ç¢ºæ¨™ç¤ºæ”¯æ´çš„æ¨¡å‹

### 2. Schema æ ¼å¼å¿…é ˆå®Œæ•´

**OpenAI function calling æ ¼å¼è¦æ±‚**ï¼š
```json
{
  "type": "function",
  "function": {
    "name": "tool_name",
    "description": "...",
    "parameters": {
      "type": "object",      // â† å¿…é ˆ
      "properties": {...},   // â† å¿…é ˆ
      "required": [...]      // â† å¿…é ˆ
    }
  }
}
```

### 3. ç•°æ­¥ç’°å¢ƒå¿…é ˆä½¿ç”¨ç•°æ­¥èª¿ç”¨

- MCP å·¥å…·æ˜¯ç•°æ­¥çš„
- åœ¨ FastAPI async endpoint ä¸­å¿…é ˆä½¿ç”¨ `await agent.ainvoke()`
- ä¸èƒ½ä½¿ç”¨åŒæ­¥çš„ `agent.invoke()`

## ä½•æ™‚æ‡‰è©²åƒè€ƒé€™ä»½æ–‡ä»¶

### âœ… åƒè€ƒæ™‚æ©Ÿ

1. **å¯¦ä½œ LangGraph + MCP æ•´åˆæ™‚**
   - é¸æ“‡æ¨¡å‹æ™‚
   - å·¥å…·èª¿ç”¨ç„¡æ³•æ­£å¸¸å·¥ä½œæ™‚
   - çœ‹åˆ° `StructuredTool does not support sync invocation` éŒ¯èª¤æ™‚

2. **ä½¿ç”¨ LM Studio çš„ function calling åŠŸèƒ½æ™‚**
   - å·¥å…·åªè¼¸å‡º JSON æ–‡å­—ï¼Œæ²’æœ‰å¯¦éš›èª¿ç”¨æ™‚
   - Schema æ ¼å¼éŒ¯èª¤æ™‚ï¼ˆ`Invalid discriminator value. Expected 'object'`ï¼‰

3. **å»ºç«‹ Agentic AI ç³»çµ±æ™‚**
   - éœ€è¦è‡ªä¸»å¤šæ­¥é©ŸåŸ·è¡Œèƒ½åŠ›æ™‚
   - éœ€è¦å·¥å…·èª¿ç”¨åŠŸèƒ½æ™‚

## ç›¸é—œæ–‡ä»¶

- `/Users/40gpu/coding_projects/langgraph-local/docs/åœ°é›·-LangGraph-MCP-æ•´åˆ.txt`
- `/Users/40gpu/coding_projects/langgraph-local/agent.py`
- `/Users/40gpu/coding_projects/langgraph-local/server.py`
- `/Users/40gpu/coding_projects/langgraph-local/CLAUDE.md`

## ç¸½çµ

### æ ¸å¿ƒè¦é»

1. **æ¨¡å‹é¸æ“‡**ï¼šä½¿ç”¨ gpt-oss-20b è€Œä¸æ˜¯ gemma-3n
2. **Schema ä¿®æ­£**ï¼šç¢ºä¿æ‰€æœ‰å·¥å…· schema åŒ…å« type/properties/required
3. **ç•°æ­¥èª¿ç”¨**ï¼šåœ¨ async ç’°å¢ƒä¸­ä½¿ç”¨ `await agent.ainvoke()`

### æˆåŠŸæŒ‡æ¨™

âœ… Agent åŸ·è¡Œè»Œè·¡ä¸­çœ‹åˆ° `ğŸ”§ Agent å‘¼å«å·¥å…·`
âœ… çœ‹åˆ° `ğŸ“Š å·¥å…·çµæœ`
âœ… æœ€çµ‚å›æ‡‰åŒ…å«å¯¦éš›çš„å·¥å…·åŸ·è¡Œçµæœ

### å¤±æ•—æŒ‡æ¨™

âŒ åªçœ‹åˆ° `tool_request` æˆ– `tool_code` çš„ JSON è¼¸å‡º
âŒ æ²’æœ‰å¯¦éš›çš„å·¥å…·èª¿ç”¨è»Œè·¡
âŒ `StructuredTool does not support sync invocation` éŒ¯èª¤

==========================================
æ›´æ–°ï¼š2025-11-23
ç‰ˆæœ¬ï¼š1.0
==========================================
